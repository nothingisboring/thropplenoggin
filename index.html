 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oblique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee Outline&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
   
<body class="flex flex-col items-center min-h-screen p-4"> <header class="text-center mb-6 w-full max-w-3xl">
         <img
            src="https://see.fontimg.com/api/rf5/jr40/YzY2YzczZGI3MzIxNDIxOWE2ZmUwOThlZTA5MzMxNGMudHRm/T0JMSVFVRQ/blus-blocks.png?r=dw&h=56&w=1000&fg=0C1442&bg=FFFFFF&s=56"
            alt="Game Banner - Replace with descriptive text"
            class="w-50 h-auto mb-4 rounded-md shadow-sm game-banner-image mx-auto"
            onerror="this.onerror=null; this.src='https://placehold.co/800x150/cccccc/ffffff?text=Image+Error';">
        <h2 class="text-1xl font-bold mb-2 text-stone-600"></h2>
        <h2 class="text-1xl font-regular mb-2 text-stone-600">Can you solve today's slightly oblique cultural puzzle?</h2>
        <div id="source-type-emoji" class="text-2xl mb-2"></div> 
         <div id="score-display"></div>
    <!-- Add this inside the <body> tag -->
<button id="howToPlayButton" title="How to Play" 
    class="fixed bottom-4 right-4 w-12 h-12 bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center text-lg hover:bg-gray-700 z-50">
    ?
</button>

<!-- Add a hidden modal for instructions -->
<div id="howToPlayModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
        <h3 class="text-xl font-bold mb-4 text-center">How to Play</h3>
        <p class="text-gray-700 text-sm mb-4">
            Solve the cryptic cultural puzzle by completing each phase:
            <br><br>
            - **Phase 1:** Solve the clues around the center box.
            <br>
            - **Phase 2:** Solve the four corner clues after Phase 1.
            <br>
            - **Phase 3:** Solve the final clue in the center box.
            <br><br>
            Click on a box to answer, and submit your guess. Good luck!
        </p>
        <button id="closeModalButton" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 w-full">
            Got it!
        </button>
    </div>
</div>
         </header>

    <div id="message-area" class="h-10 mb-4 text-center font-medium"></div>

    <div id="missing-link-grid" class="missing-link-grid">
        </div>

     <div id="solutions-modal-container"></div>

  </head>
<body class="flex flex-col items-center min-h-screen p-4 bg-stone-100">

    <header class="text-center mb-4">
    <h1 class="text-4xl font-bold mb-2 text-stone-800"></h1>
    <div id="puzzle-title" class="text-lg text-stone-700"></div>
    <div id="source-type-emoji" class="text-2xl mb-2"></div>
</header>

    <div id="message-area" class="h-10 mb-4 text-center font-medium"></div>

    <div id="missing-link-grid" class="missing-link-grid">
         </div>
    <style>
        body {
            /* --- DEFAULT THEME COLOR VARIABLES --- */
            --clr-bg: #f5f5f4;              /* stone-100 */
            --clr-text-default: #1f2937;   /* gray-800 */
            --clr-text-muted: #57534e;     /* stone-600 */
            --clr-text-header: #44403c;    /* stone-700 */
            --clr-text-placeholder: #9ca3af; /* coolGray-400 */
            --clr-text-link: #12b093;       /* Primary Action/Solved Link */
            --clr-text-final-clue: #7c2d12; /* amber-900 */
            --clr-text-on-solved: #ffffff;
            --clr-text-on-primary: #ffffff;
            --clr-text-p2-inactive: #64748b; /* slate-500 */

            --clr-border-default: #d1d5db;  /* gray-300 */
            --clr-border-backface: #7dd3fc; /* sky-300 */
            --clr-border-error: #ef4444;    /* red-500 */
            --clr-border-solved: #0e8e77;   /* Darker primary */
            --clr-border-p2-inactive: #5eead4; /* teal-300 */

            --clr-primary: #12b093;         /* Main action color (buttons, solved boxes) */
            --clr-primary-hover: #0e8e77;   /* Darker primary */
            --clr-primary-disabled: #6cd4c1;/* Lighter primary */
            --clr-secondary-info: #7dd3fc;  /* Info/Backface borders (sky-300) */
            --clr-error: #ef4444;           /* Error state red */
            --clr-error-bg: #fee2e2;        /* red-100 */

            --clr-box-bg-front: #ffffff;
            --clr-box-bg-back: #f0f9ff;      /* sky-50 */
            --clr-box-bg-solved: var(--clr-primary);
            --clr-box-bg-final: #0a5c4d;     /* Darkest teal for final center */
            --clr-box-bg-p2-inactive-front: #f0fdfa; /* teal-50 */
            --clr-box-bg-p2-inactive-back: #ccfbf1;  /* teal-100 */

            --clr-glow-1: var(--clr-secondary-info); /* sky-300 */
            --clr-glow-2: #0ea5e9;          /* sky-500 */

             /* Message Colors (used via JS - define CSS rules below) */
            --clr-message-success: var(--clr-primary);
            --clr-message-info: var(--clr-glow-2); /* sky-500 */
            --clr-message-warning: #f97316; /* orange-500 */
            --clr-message-error: var(--clr-error);
            --clr-message-final: #8b5cf6;  /* purple-500 */
            /* --- End Default Theme Variables --- */

            font-family: 'Inter', sans-serif;
            background-color: var(--clr-bg);
            transition: background-color 0.5s ease; /* Smooth transition for bg */
        }

        /* --- Mondrian Theme Override --- */
        body.mondrian-theme {
            /* Re-define variables for the Mondrian look */
            --clr-bg: #FFFFFF;              /* White background */
            --clr-text-default: #000000;   /* Black text */
            --clr-text-muted: #000000;     /* Black muted text */
            --clr-text-header: #000000;    /* Black header */
            --clr-text-placeholder: #777777; /* Gray placeholder on White/Yellow */
            --clr-text-link: #0000FF;       /* Blue solved link */
            --clr-text-final-clue: #000000; /* Black final clue text */
            --clr-text-on-solved: #FFFFFF; /* White text on Red/Blue solved boxes */
            --clr-text-on-primary: #FFFFFF;/* White text on Red buttons */
            --clr-text-p2-inactive: #000000; /* Black '?' */

            --clr-border-default: #000000;  /* Black borders */
            --clr-border-backface: #0000FF; /* Blue border for back face */
            --clr-border-error: #FF0000;    /* Red error border */
            --clr-border-solved: #000000;   /* Black border for solved boxes */
            --clr-border-p2-inactive: #FFFF00; /* Yellow dashed border for inactive P2 */

            --clr-primary: #FF0000;         /* Red for primary buttons/solved boxes */
            --clr-primary-hover: #CC0000;   /* Darker Red */
            --clr-primary-disabled: #FF9999;/* Lighter Red */
            --clr-secondary-info: #0000FF;  /* Blue for secondary elements */
            --clr-error: #FF0000;           /* Red error text */
            --clr-error-bg: #FFDDDD;        /* Light Red error background */

            --clr-box-bg-front: #FFFFFF;    /* White front face */
            --clr-box-bg-back: #FFFF00;      /* Yellow back face */
            --clr-box-bg-solved: var(--clr-primary); /* Red solved background */
            --clr-box-bg-final: #0000FF;     /* Blue final center box background */
            --clr-box-bg-p2-inactive-front: #FFFFFF; /* White bg for inactive P2 */
            --clr-box-bg-p2-inactive-back: #FFFFFF;  /* White bg for inactive P2 back */

            --clr-glow-1: var(--clr-secondary-info); /* Blue glow */
            --clr-glow-2: #FFFF00;          /* Yellow glow */

             /* Message Colors */
            --clr-message-success: #0000FF;  /* Blue success */
            --clr-message-info: #0000FF;     /* Blue info */
            --clr-message-warning: #FF0000; /* Red warning */
            --clr-message-error: #FF0000;   /* Red error */
            --clr-message-final: #000000;  /* Black final message */

             /* --- Optional: Thicker Borders --- */
             /* --border-width-default: 3px; */ /* Uncomment and apply below if desired */
        }
        /* Optional: Apply thicker borders in Mondrian theme */
        /*
        body.mondrian-theme .clue-box-front,
        body.mondrian-theme .clue-box-back,
        body.mondrian-theme .missing-link-center {
             border-width: var(--border-width-default, 3px);
             border-style: solid; // Ensure solid if changing width
        }
        body.mondrian-theme .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-front,
        body.mondrian-theme .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-back {
            border-style: dashed; // Keep dashed for inactive P2
        }
        */

        /* --- Define rules for JS-added text classes using variables --- */
        .text-teal-600 { color: var(--clr-message-success); }
        .text-blue-600 { color: var(--clr-message-info); }
        .text-orange-600 { color: var(--clr-message-warning); }
        .text-red-600 { color: var(--clr-message-error); }
        .text-purple-600 { color: var(--clr-message-final); }


        h1 {
            font-family: 'Badeen Display', Sans-Serif;
            font-weight: 400;
        }

        h2 {
            font-family: 'Poppins', Sans-Serif;
            font-weight: 400;
        }


        /* --- Animations --- */
        @keyframes shake { /* No colors here */
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); } 20%, 40%, 60%, 80% { transform: translateX(6px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes reveal { /* No colors here */
            0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; }
        }
        .final-celebration { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { /* No colors here */
            0%, 100% { opacity: 1; } 50% { opacity: .7; }
        }
        @keyframes glow { /* Uses variables */
            0%, 100% { box-shadow: 0 0 10px var(--clr-glow-1); }
            50% { box-shadow: 0 0 20px var(--clr-glow-2); }
        }
        .center-glow { animation: glow 2s infinite ease-in-out; transition: background-color 0.3s ease; }
         @keyframes fadeIn { /* No colors here */
            from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); }
        }
        .solutions-modal { animation: fadeIn 0.3s ease-out; }


        /* --- General Styles --- */
        #source-type-emoji { font-size: 2rem; line-height: 1; margin-bottom: 0.5rem; }
        #puzzle-title { color: var(--clr-text-header); transition: color 0.5s ease; }

        /* Grid container */
        .missing-link-grid {
            display: grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); grid-template-rows: repeat(3, minmax(100px, 1fr));
            gap: 1rem; width: 100%; max-width: 500px; aspect-ratio: 1 / 1; margin-bottom: 1.5rem;
        }

        /* Central Missing Link Box */
        .missing-link-center {
            grid-column: 2 / 3; grid-row: 2 / 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--clr-box-bg-front); border: 2px solid var(--clr-border-default);
            border-radius: 0.375rem; padding: 1rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); text-align: center; min-height: 120px;
             transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .missing-link-center input {
            width: 90%; padding: 6px 10px; border: 1px solid var(--clr-border-default);
            border-radius: 0.25rem; margin-bottom: 8px; text-align: center;
            color: var(--clr-text-default); background-color: var(--clr-box-bg-front); /* Ensure input colors match theme */
        }
         .missing-link-center input::placeholder { color: var(--clr-text-placeholder); }
         .missing-link-center input.input-error { border-color: var(--clr-border-error); background-color: var(--clr-error-bg); }
        .missing-link-center button {
            padding: 4px 12px; font-size: 0.85rem; background-color: var(--clr-primary); color: var(--clr-text-on-primary);
            border: none; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s;
        }
        .missing-link-center button:hover:not(:disabled) { background-color: var(--clr-primary-hover); }
        .missing-link-center button:disabled { background-color: var(--clr-primary-disabled); cursor: not-allowed; }
        .missing-link-center p { font-size: 0.8rem; color: var(--clr-text-muted); margin-bottom: 5px; transition: color 0.5s ease;}
        .missing-link-center .correct-link { font-weight: 700; font-size: 1.1rem; color: var(--clr-text-link); animation: reveal 0.6s ease-out forwards; transition: color 0.5s ease;}

        /* --- Clue Box Styles (Used for Phase 1 & Phase 2) --- */
        .clue-box-container { perspective: 1000px; min-height: 100px; height: 100%; }
        .clue-box-container[data-clue-id='1'] { grid-column: 2 / 3; grid-row: 1 / 2; }
        .clue-box-container[data-clue-id='2'] { grid-column: 1 / 2; grid-row: 2 / 3; }
        .clue-box-container[data-clue-id='3'] { grid-column: 3 / 4; grid-row: 2 / 3; }
        .clue-box-container[data-clue-id='4'] { grid-column: 2 / 3; grid-row: 3 / 4; }

        .clue-box-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .clue-box-container.is-flipped .clue-box-inner { transform: rotateY(180deg); }

        .clue-box-front, .clue-box-back {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.75rem;
            border: 2px solid var(--clr-border-default); border-radius: 0.375rem; background-color: var(--clr-box-bg-front);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); color: var(--clr-text-default);
             transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease; /* Add transitions */
        }
        .clue-box-back { background-color: var(--clr-box-bg-back); border-color: var(--clr-border-backface); transform: rotateY(180deg); }
        .clue-box-back input {
            width: 90%; padding: 4px 8px; border: 1px solid var(--clr-border-default); border-radius: 0.25rem; margin-bottom: 5px; text-align: center; font-size: 0.85rem;
            color: var(--clr-text-default); background-color: var(--clr-box-bg-front); /* Ensure input colors match theme */
        }
        .clue-box-back input.input-error { border-color: var(--clr-border-error); background-color: var(--clr-error-bg); }
        .clue-box-back button {
             padding: 3px 10px; font-size: 0.8rem; background-color: var(--clr-primary); color: var(--clr-text-on-primary);
             border: none; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s;
         }
        .clue-box-back button:hover:not(:disabled) { background-color: var(--clr-primary-hover); }
         .clue-box-back button:disabled { background-color: var(--clr-primary-disabled); cursor: not-allowed; }

        /* Solved states */
        .clue-box-container.clue-solved .clue-box-front { background-color: var(--clr-box-bg-solved); border-color: var(--clr-border-solved); color: var(--clr-text-on-solved); font-weight: 500; }
        .clue-box-container.clue-solved .clue-box-inner { cursor: default; }

        /* Dimming / Interactivity states */
        .puzzle-solved .clue-box-container[data-clue-id] .clue-box-front { opacity: 0.7; }
        .puzzle-solved .clue-box-inner { cursor: default; }

        .phase2-inactive { opacity: 0.65; pointer-events: none; }
         /* Specific styling for INACTIVE Phase 2 boxes */
         .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-front,
         .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-back {
             background-color: var(--clr-box-bg-p2-inactive-front); border-color: var(--clr-border-p2-inactive);
             border-style: dashed; border-width: 2px;
         }
         .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-back { background-color: var(--clr-box-bg-p2-inactive-back); }
         .clue-box-container.phase2-inactive[data-phase2-clue-id] .clue-box-front { color: var(--clr-text-p2-inactive); font-weight: bold; }
         .phase2-inactive .clue-box-inner { cursor: default; }

        /* Make sure active styles override the inactive ones */
         .clue-box-container.phase2-active:not(.clue-solved)[data-phase2-clue-id] .clue-box-front {
             background-color: var(--clr-box-bg-front); border-color: var(--clr-border-default); border-style: solid;
             color: var(--clr-text-default); font-weight: normal;
         }
          .clue-box-container.phase2-active:not(.clue-solved)[data-phase2-clue-id] .clue-box-back {
             background-color: var(--clr-box-bg-back); border-color: var(--clr-border-backface); border-style: solid;
         }
         .phase2-active .clue-box-inner { cursor: pointer; }


        /* --- Phase 3 Styles --- */
        .phase3-solution {
            font-weight: 700; font-size: 1.2rem; color: var(--clr-text-on-solved); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            background-color: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 4px; animation: reveal 0.6s ease-out forwards;
        }
        .phase3-clue {
            font-weight: 500; font-size: 0.85rem; color: var(--clr-text-final-clue); margin: 8px 0; padding: 0 8px; text-align: center;
            transition: color 0.5s ease;
        }
        #phase3-guess {
            width: 85%; padding: 4px 8px; font-size: 0.85rem; border: 1px solid var(--clr-border-default);
            border-radius: 0.25rem; margin-bottom: 6px; text-align: center;
            color: var(--clr-text-default); background-color: var(--clr-box-bg-front); /* Ensure input colors match theme */
        }
        #submit-phase3 {
            padding: 4px 12px; font-size: 0.8rem; background-color: var(--clr-primary); color: var(--clr-text-on-primary);
            border: none; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; line-height: 1.2;
        }
        #submit-phase3:hover:not(:disabled) { background-color: var(--clr-primary-hover); }
         #submit-phase3:disabled { background-color: var(--clr-primary-disabled); cursor: not-allowed; }

        .missing-link-center.phase3-active {
            padding: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; min-height: 120px;
            background-color: var(--clr-box-bg-front); /* Use variable for active P3 center */
        }
        /* Style for the final solved center box */
        .missing-link-center.final-solved {
             background-color: var(--clr-box-bg-final) !important; /* Use variable - important if needed */
             border-color: var(--clr-box-bg-final);
        }

        /* Modal Styles */
        .solutions-modal { /* Basic structure, colors depend on content */
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; text-align: center; max-width: 90%; width: 300px;
        }
         /* Style modal content using variables where appropriate */
         .solutions-modal h3 { color: var(--clr-text-header); /* Example */ }
         .solutions-modal p { color: var(--clr-text-link); /* Example */}
         .solutions-modal button { background-color: var(--clr-primary); color: var(--clr-text-on-primary); /* Example */ }


    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4"> <header class="text-center mb-6 w-full max-w-3xl">
         <img
            src="https://see.fontimg.com/api/rf5/M3KJ/MWZiZjc0YTAwZTcwNDliMWE5ODhkZDgyYjM3YzIzNTEudHRm/dGhyb3BwbGVub2dnaW4/jd-eugenia-regular.png?r=fs&h=34&w=1000&fg=061048&bg=FAFAFA&tb=1&s=34"
            alt="Game Banner - Replace with descriptive text"
            class="w-50 h-auto mb-4 rounded-md shadow-sm game-banner-image mx-auto"
            onerror="this.onerror=null; this.src='https://placehold.co/800x150/cccccc/ffffff?text=Image+Error';"
         >
        <h2 class="text-1xl font-bold mb-2 text-stone-600">Clodhopper or cognoscente?</h2>
        <h2 class="text-1xl font-regular mb-2 text-stone-600">Solve the cunning cultural puzzle to find out!</h2>
        <div id="source-type-emoji" class="text-5xl mb-2"></div> 
         <div id="puzzle-title" class="text-lg text-stone-700">Solve the clues to find the link!</div>
         <div id="score-display"></div>
         </header>

    <div id="message-area" class="h-10 mb-4 text-center font-medium"></div>

    <div id="missing-link-grid" class="missing-link-grid">
        </div>

     <div id="solutions-modal-container"></div>


    <script>
        // --- Game Data --- (No changes)
        const gameData = { missingLink: "Composition with Red, Blue and Yellow", sourceTypeEmoji: '🎨', phase3Solution: "White", phase3Clue: "What links the surrounding answers?", clues: [ { id: 1, text: "Warning", solution: "Red", solved: false }, { id: 2, text: "Custard", solution: "Yellow", solved: false }, { id: 3, text: "Sad", solution: "Blue", solved: false }, { id: 4, text: "Demonstrably sad", solution: "Black", solved: false } ], phase2Clues: [ { id: 'p2_1', gridPos: [1, 1], text: "Low IQ, presidentially so? (5)", solution: "Thick", solved: false }, { id: 'p2_2', gridPos: [1, 3], text: "Up (8)", solution: "Vertical", solved: false }, { id: 'p2_3', gridPos: [3, 1], text: "Sideways (10)", solution: "Horizontal", solved: false }, { id: 'p2_4', gridPos: [3, 3], text: "White ones blow away, apparently (5)", solution: "Lines", solved: false } ], getClueById: function(id) { return this.clues.find(clue => clue.id === id); }, getPhase2ClueById: function(id) { return this.phase2Clues.find(clue => clue.id === id); } };

        // --- Game State --- (No changes)
        let solvedCluesCount = 0, totalClues = gameData.clues.length, linkSolved = false, phase2Active = false, solvedPhase2Count = 0, totalPhase2Clues = gameData.phase2Clues.length, phase3Active = false, phase3Solved = false, gameComplete = false;

        // --- DOM Elements --- (No changes)
        const gridEl = document.getElementById('missing-link-grid'), messageAreaEl = document.getElementById('message-area'), emojiIndicatorEl = document.getElementById('source-type-emoji'), puzzleTitleEl = document.getElementById('puzzle-title'), solutionsModalContainerEl = document.getElementById('solutions-modal-container');

        // --- Initialization ---
        function initGame() {
            // *** Reset Theme ***
            document.body.classList.remove('mondrian-theme');
            // ******************

            gridEl.innerHTML = ''; solvedCluesCount = 0; linkSolved = false; phase2Active = false; solvedPhase2Count = 0; phase3Active = false; phase3Solved = false; gameComplete = false; messageAreaEl.textContent = ''; puzzleTitleEl.textContent = ''; emojiIndicatorEl.textContent = gameData.sourceTypeEmoji || ''; solutionsModalContainerEl.innerHTML = '';
            gameData.clues.forEach(clue => clue.solved = false); gameData.phase2Clues.forEach(clue => clue.solved = false);
            gameData.clues.forEach(clueData => gridEl.appendChild(createPhase1ClueBox(clueData)));
            gridEl.appendChild(createCenterBox()); gameData.phase2Clues.forEach(p2Data => gridEl.appendChild(createPhase2ClueBox(p2Data)));
            checkAllCluesSolved();
            messageAreaEl.style.color = 'var(--clr-text-default)'; // Ensure message area resets color
        }

        // --- Element Creation Functions --- (No changes)
        function createPhase1ClueBox(clueData){ const container=document.createElement('div'); container.classList.add('clue-box-container'); container.dataset.clueId=clueData.id; const {inner, front, back}=createClueBoxInnerStructure(clueData.text); const input=createClueInput(); input.addEventListener('keydown', (e)=>{ if(e.key==='Enter')handleClueSubmit(clueData.id); input.classList.remove('input-error'); }); const button=createClueButton('Submit'); button.addEventListener('click', (e)=>{ e.stopPropagation(); handleClueSubmit(clueData.id); }); back.appendChild(input); back.appendChild(button); inner.appendChild(front); inner.appendChild(back); container.appendChild(inner); container.addEventListener('click', handleBoxClick); return container; }
        function createPhase2ClueBox(p2Data){ const container=document.createElement('div'); container.classList.add('clue-box-container', 'phase2-inactive'); container.dataset.phase2ClueId=p2Data.id; container.style.gridColumn=`${p2Data.gridPos[1]} / span 1`; container.style.gridRow=`${p2Data.gridPos[0]} / span 1`; const {inner, front, back}=createClueBoxInnerStructure("?"); const input=createClueInput(); input.addEventListener('keydown', (e)=>{ if(e.key==='Enter')handlePhase2ClueSubmit(p2Data.id); input.classList.remove('input-error'); }); const button=createClueButton('Submit'); button.addEventListener('click', (e)=>{ e.stopPropagation(); handlePhase2ClueSubmit(p2Data.id); }); back.appendChild(input); back.appendChild(button); inner.appendChild(front); inner.appendChild(back); container.appendChild(inner); container.addEventListener('click', handleBoxClick); return container; }
        function createClueBoxInnerStructure(clueText){ const inner=document.createElement('div'); inner.classList.add('clue-box-inner'); const front=document.createElement('div'); front.classList.add('clue-box-front'); front.textContent=clueText; const back=document.createElement('div'); back.classList.add('clue-box-back'); return {inner, front, back}; }
        function createClueInput(){ const input=document.createElement('input'); input.type='text'; input.placeholder='Your answer...'; return input; }
        function createClueButton(text){ const button=document.createElement('button'); button.textContent=text; return button; }
        function createCenterBox(){ const centerBox=document.createElement('div'); centerBox.classList.add('missing-link-center'); centerBox.id='missing-link-center-box'; const centerTitle=document.createElement('p'); centerTitle.textContent='The Missing Link?'; centerTitle.id='missing-link-title'; const centerInput=document.createElement('input'); centerInput.type='text'; centerInput.id='missing-link-guess'; centerInput.placeholder='Guess the link...'; centerInput.disabled=true; centerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter')handleLinkSubmit(); centerInput.classList.remove('input-error'); }); const centerButton=document.createElement('button'); centerButton.id='submit-link'; centerButton.textContent='Submit Link'; centerButton.disabled=true; centerButton.addEventListener('click', handleLinkSubmit); centerBox.appendChild(centerTitle); centerBox.appendChild(centerInput); centerBox.appendChild(centerButton); return centerBox; }

        // --- Event Handlers & Logic ---
        function handleBoxClick(event){ const container=event.currentTarget; if(gameComplete||phase3Active)return; const isPhase1Box=container.hasAttribute('data-clue-id'); const isPhase2Box=container.hasAttribute('data-phase2-clue-id'); let clueData; let canFlip=false; if(isPhase1Box&&!linkSolved&&!phase2Active){ clueData=gameData.getClueById(parseInt(container.dataset.clueId)); canFlip=clueData&&!clueData.solved; } else if(isPhase2Box&&phase2Active){ clueData=gameData.getPhase2ClueById(container.dataset.phase2ClueId); canFlip=clueData&&!clueData.solved; } if(!canFlip)return; if(container.classList.contains('is-flipped')){ if(event.target.tagName==='INPUT'||event.target.tagName==='BUTTON')return; container.classList.remove('is-flipped'); clearMessage(); } else { container.classList.add('is-flipped'); const input=container.querySelector('.clue-box-back input'); if(input)input.focus(); clearMessage(); } }
        function handleClueSubmit(clueId){ if(linkSolved||gameComplete||phase2Active)return; const container=gridEl.querySelector(`.clue-box-container[data-clue-id='${clueId}']`); const input=container.querySelector('.clue-box-back input'); const front=container.querySelector('.clue-box-front'); const clueData=gameData.getClueById(clueId); const guess=input.value.trim(); if(!clueData||!guess||clueData.solved)return; const normalizedGuess=guess.toLowerCase().replace(/\s+/g, ' '); const normalizedSolution=clueData.solution.toLowerCase().replace(/\s+/g, ' '); if(normalizedGuess===normalizedSolution){ clueData.solved=true; solvedCluesCount++; front.textContent=clueData.solution; container.classList.add('clue-solved'); container.classList.remove('is-flipped'); input.value=''; input.disabled=true; container.querySelector('.clue-box-back button').disabled=true; displayMessage(`Clue ${clueId} solved!`, 'text-teal-600'); checkAllCluesSolved(); } else { input.classList.add('input-error'); displayMessage('Incorrect clue answer.', 'text-orange-600'); container.querySelector('.clue-box-inner').classList.add('shake'); setTimeout(()=>{ container.querySelector('.clue-box-inner').classList.remove('shake'); }, 500); } }
        function checkAllCluesSolved(){ const linkInput=document.getElementById('missing-link-guess'); const linkButton=document.getElementById('submit-link'); if(solvedCluesCount===totalClues&&!linkSolved){ linkInput.disabled=false; linkButton.disabled=false; displayMessage('All Phase 1 clues solved! Guess the Missing Link?', 'text-teal-600'); linkInput.focus(); } else if(!linkSolved){ linkInput.disabled=true; linkButton.disabled=true; } }
        function handleLinkSubmit() {
            if (linkSolved || gameComplete) return;
            const linkInput = document.getElementById('missing-link-guess'); const guess = linkInput.value.trim(); const normalizedGuess = guess.toLowerCase().replace(/\s+/g, ' '); const normalizedSolution = gameData.missingLink.toLowerCase().replace(/\s+/g, ' ');
            if (normalizedGuess === normalizedSolution) {
                linkSolved = true; displayMessage('Missing Link Correct!', 'text-teal-600'); linkInput.disabled = true; document.getElementById('submit-link').disabled = true; document.getElementById('missing-link-title').textContent = 'Link Found!';
                const centerBox = document.getElementById('missing-link-center-box'); linkInput.style.display = 'none'; document.getElementById('submit-link').style.display = 'none';
                const solvedLinkText = document.createElement('div'); solvedLinkText.classList.add('correct-link'); solvedLinkText.textContent = gameData.missingLink; centerBox.appendChild(solvedLinkText);

                // *** Apply Mondrian Theme ***
                document.body.classList.add('mondrian-theme');
                // **************************

                gridEl.classList.add('puzzle-solved');
                setTimeout(startPhase2, 1000);
            } else {
                displayMessage('Incorrect Missing Link guess. Try again.', 'text-red-600'); linkInput.classList.add('input-error'); const centerBox = document.getElementById('missing-link-center-box'); centerBox.classList.add('shake'); setTimeout(() => { centerBox.classList.remove('shake'); }, 500);
            }
        }
        function startPhase2(){ if(gameComplete||phase2Active)return; phase2Active=true; puzzleTitleEl.textContent="Phase 2: Solve the corner clues!"; displayMessage('Solve the four corner clues!', 'text-blue-600'); const phase2Boxes=gridEl.querySelectorAll('.clue-box-container[data-phase2-clue-id]'); phase2Boxes.forEach(box =>{ const phase2ClueId=box.dataset.phase2ClueId; const clueData=gameData.getPhase2ClueById(phase2ClueId); const frontElement=box.querySelector('.clue-box-front'); if(clueData&&frontElement){ frontElement.textContent=clueData.text; } box.classList.remove('phase2-inactive'); box.classList.add('phase2-active'); box.querySelector('.clue-box-inner').style.cursor='pointer'; }); const phase1Boxes=gridEl.querySelectorAll('.clue-box-container[data-clue-id]'); phase1Boxes.forEach(box =>{ box.querySelector('.clue-box-inner').style.cursor='default'; }); }
        function handlePhase2ClueSubmit(phase2ClueId){ if(gameComplete||!phase2Active||phase3Active)return; const container=gridEl.querySelector(`.clue-box-container[data-phase2-clue-id='${phase2ClueId}']`); const input=container.querySelector('.clue-box-back input'); const front=container.querySelector('.clue-box-front'); const clueData=gameData.getPhase2ClueById(phase2ClueId); const guess=input.value.trim(); if(!clueData||!guess||clueData.solved)return; const normalizedGuess=guess.toLowerCase().replace(/\s+/g, ' '); const normalizedSolution=clueData.solution.toLowerCase().replace(/\s+/g, ' '); if(normalizedGuess===normalizedSolution){ clueData.solved=true; solvedPhase2Count++; front.textContent=clueData.solution; container.classList.add('clue-solved'); container.classList.remove('is-flipped'); input.value=''; input.disabled=true; container.querySelector('.clue-box-back button').disabled=true; container.querySelector('.clue-box-inner').style.cursor='default'; displayMessage(`Phase 2 Clue ${solvedPhase2Count}/${totalPhase2Clues} solved!`, 'text-teal-600'); if(solvedPhase2Count===totalPhase2Clues){ setTimeout(startPhase3, 1000); } } else { input.classList.add('input-error'); displayMessage('Incorrect Phase 2 answer.', 'text-orange-600'); container.querySelector('.clue-box-inner').classList.add('shake'); setTimeout(()=>{ container.querySelector('.clue-box-inner').classList.remove('shake'); }, 500); } }
        function startPhase3(){ if(gameComplete||phase3Active)return; phase3Active=true; phase2Active=false; puzzleTitleEl.textContent="Phase 3: One final clue!"; displayMessage('The center holds one final clue!', 'text-purple-600'); const centerBox=document.getElementById('missing-link-center-box'); centerBox.innerHTML=''; centerBox.classList.add('center-glow', 'phase3-active'); centerBox.style.backgroundColor=''; const phase3ClueEl=document.createElement('div'); phase3ClueEl.classList.add('phase3-clue'); phase3ClueEl.textContent=gameData.phase3Clue; centerBox.appendChild(phase3ClueEl); const formContainer=document.createElement('div'); formContainer.style.cssText='display: flex; flex-direction: column; align-items: center; width: 100%; gap: 6px;'; const phase3Input=document.createElement('input'); phase3Input.type='text'; phase3Input.id='phase3-guess'; phase3Input.placeholder='Final answer...'; phase3Input.addEventListener('keydown', (e)=>{ if(e.key==='Enter')handlePhase3Submit(); phase3Input.classList.remove('input-error'); }); const phase3Button=document.createElement('button'); phase3Button.id='submit-phase3'; phase3Button.textContent='Submit Final Answer'; phase3Button.addEventListener('click', handlePhase3Submit); formContainer.appendChild(phase3Input); formContainer.appendChild(phase3Button); centerBox.appendChild(formContainer); const phase2Boxes=gridEl.querySelectorAll('.clue-box-container[data-phase2-clue-id]'); phase2Boxes.forEach(box =>{ box.classList.remove('phase2-active'); box.querySelector('.clue-box-inner').style.cursor='default'; if(!box.classList.contains('clue-solved')){ box.style.opacity='0.7'; } }); phase3Input.focus(); }
        function handlePhase3Submit(){ if(gameComplete||!phase3Active)return; const phase3Input=document.getElementById('phase3-guess'); const guess=phase3Input.value.trim(); if(!guess)return; const normalizedGuess=guess.toLowerCase().replace(/\s+/g, ' '); const normalizedSolution=gameData.phase3Solution.toLowerCase().replace(/\s+/g, ' '); if(normalizedGuess===normalizedSolution){ phase3Solved=true; gameComplete=true; phase3Active=false; const centerBox=document.getElementById('missing-link-center-box'); centerBox.classList.remove('center-glow', 'phase3-active'); centerBox.classList.add('final-solved'); centerBox.innerHTML=''; const finalSolutionText=document.createElement('div'); finalSolutionText.classList.add('phase3-solution'); finalSolutionText.textContent=gameData.phase3Solution; centerBox.appendChild(finalSolutionText); gridEl.querySelectorAll('input, button').forEach(el => el.disabled=true); gridEl.style.pointerEvents='none'; setTimeout(endGameCelebration, 500); } else { phase3Input.classList.add('input-error'); displayMessage('Incorrect final answer. Try again.', 'text-orange-600'); const centerBox=document.getElementById('missing-link-center-box'); centerBox.classList.add('shake'); setTimeout(()=>{ centerBox.classList.remove('shake'); }, 500); } }

        // --- Utility Functions ---
        function showSolutionsModal(){ solutionsModalContainerEl.innerHTML=''; const modal=document.createElement('div'); modal.classList.add('solutions-modal'); modal.style.cssText=` position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; text-align: center; max-width: 90%; width: 300px; `; modal.innerHTML=` <h3 style="font-weight: bold; margin-bottom: 15px; font-size: 1.1em; color: var(--clr-text-header);">Link Found!</h3> <p style="font-size: 1.2em; font-weight: 500; color: var(--clr-text-link); margin-bottom: 20px;">${gameData.missingLink}</p> <button onclick="this.closest('.solutions-modal').nextElementSibling.remove(); this.closest('.solutions-modal').remove();" style=" padding: 8px 18px; background-color: var(--clr-primary); color: var(--clr-text-on-primary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; ">Close</button> `; const overlay=document.createElement('div'); overlay.style.cssText=` position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 999; `; overlay.onclick=()=>{ overlay.remove(); modal.remove(); }; solutionsModalContainerEl.appendChild(modal); solutionsModalContainerEl.appendChild(overlay); }
        function endGameCelebration(){ puzzleTitleEl.textContent="Thropplenoggin solved!"; messageAreaEl.classList.add('final-celebration'); displayMessage('🧠 Congratulations! You are a cognoscente! 🧠', 'text-purple-600'); } // text-purple-600 uses variable now
        function displayMessage(text, styleClasses='text-stone-700'){ messageAreaEl.textContent=text; messageAreaEl.className='h-10 mb-4 text-center font-medium'; if(styleClasses){ messageAreaEl.classList.add(...styleClasses.split(' ')); } if(gameComplete&&text.includes("Congratulations")){ messageAreaEl.classList.add('final-celebration'); } } // styleClasses now map to CSS rules using variables
        function clearMessage(){ const currentText=messageAreaEl.textContent||""; if(!currentText.includes("Phase")&&!currentText.includes("Link")&&!currentText.includes("Congratulations")){ messageAreaEl.textContent=''; messageAreaEl.className='h-10 mb-4 text-center font-medium'; messageAreaEl.style.color='var(--clr-text-default)';} }

          document.addEventListener('DOMContentLoaded', () => {
    // --- Initialize Game ---
    initGame();

    // --- 'How to Play' Modal Logic ---
    const howToPlayButton = document.getElementById('howToPlayButton');
    const howToPlayModal = document.getElementById('howToPlayModal');
    const closeModalButton = document.getElementById('closeModalButton');

    // Show the modal when "How to Play" button is clicked
    howToPlayButton.addEventListener('click', () => {
        console.log('Button clicked!');
        howToPlayModal.classList.remove('hidden');
        howToPlayModal.classList.add('flex');
    });

    // Hide the modal when "Got it!" button is clicked
    closeModalButton.addEventListener('click', () => {
        howToPlayModal.classList.add('hidden');
        howToPlayModal.classList.remove('flex');
    });

    // Hide the modal if the overlay (background) is clicked
    howToPlayModal.addEventListener('click', (event) => {
        if (event.target === howToPlayModal) {
            howToPlayModal.classList.add('hidden');
            howToPlayModal.classList.remove('flex');
        }
    });
});
    </script>

</body>
</html>
